<!-- profile.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Profile</title><meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav><div class="container"> <button onclick="location='feed.html'">Back</button> ShweMyanmar - Profile</div></nav>
<div class="container">
  <div class="center-card profile-box">
    <div class="avatar" id="avatarPreview"></div>
    <div style="flex:1">
      <h3 id="pName">Loading...</h3>
      <div class="small" id="pEmail"></div>
      <div style="margin-top:8px">
        <input id="pBio" type="text" placeholder="Bio">
        <input id="avatarFile" type="file" accept="image/*">
        <button id="saveProfile">Save Profile</button>
      </div>
    </div>
  </div>

  <h4>Your posts</h4>
  <div id="myPosts"></div>
</div>

<script type="module">
import {
  auth, onAuthStateChanged,
  db, doc, getDoc, updateDoc, collection, query, where, orderBy, onSnapshot,
  storage, ref, uploadBytesResumable, getDownloadURL
} from './firebase.js';
import { timeAgo } from './utils.js';

onAuthStateChanged(auth, async user => {
  if(!user) return location='index.html';
  const uref = doc(db,'users',user.uid);
  const snap = await getDoc(uref);
  if(snap.exists()){
    const d = snap.data();
    document.getElementById('pName').textContent = d.name;
    document.getElementById('pEmail').textContent = d.email;
    document.getElementById('pBio').value = d.bio||'';
    if(d.avatar) document.getElementById('avatarPreview').style.backgroundImage = `url(${d.avatar})`;
  }

  // load user's posts
  const q = query(collection(db,'posts'), where('userId','==', user.uid), orderBy('createdAt','desc'));
  onSnapshot(q, snap => {
    const out = document.getElementById('myPosts'); out.innerHTML='';
    snap.forEach(s => {
      const p = s.data();
      const div = document.createElement('div'); div.className='post';
      div.innerHTML = `<div><b>${p.userName}</b> <div class="small">${timeAgo(p.createdAt?.toDate?.()||new Date())}</div></div><p>${escapeHtml(p.text)}</p>`;
      if(p.media) p.media.forEach(m=>{ if(m.type==='image'){ const img=document.createElement('img'); img.src=m.url; div.appendChild(img);} else { const v=document.createElement('video');v.src=m.url;v.controls=true;div.appendChild(v);} });
      out.appendChild(div);
    });
  });
});

document.getElementById('saveProfile').addEventListener('click', async ()=>{
  const bio = document.getElementById('pBio').value;
  const file = document.getElementById('avatarFile').files[0];
  const user = auth.currentUser;
  if(!user) return location='index.html';

  let avatarUrl='';
  if(file){
    const path = `avatars/${user.uid}/${Date.now()}_${file.name}`;
    const sref = ref(storage, path);
    await uploadBytesResumable(sref, file);
    avatarUrl = await getDownloadURL(sref);
  }

  const uref = doc(db,'users',user.uid);
  const updateObj = { bio };
  if(avatarUrl) updateObj.avatar = avatarUrl;
  await updateDoc(uref, updateObj);
  alert('Profile updated');
});

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
