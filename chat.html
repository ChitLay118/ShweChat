<!-- chat.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Chats</title><meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<nav><div class="container"><button onclick="location='feed.html'">Back</button> Chats</div></nav>
<div class="container layout">
  <div style="flex:1">
    <div class="center-card">
      <input id="toUserEmail" placeholder="Recipient email">
      <div id="chatWindow" style="height:400px;overflow:auto;margin-top:12px;"></div>
      <input id="chatText" placeholder="Message">
      <button id="sendChat">Send</button>
    </div>
  </div>
  <div class="side">
    <div class="center-card">
      <h4>Recent contacts</h4>
      <div id="contacts"></div>
    </div>
  </div>
</div>

<script type="module">
import {
  auth, onAuthStateChanged,
  db, collection, addDoc, query, where, onSnapshot, orderBy, getDocs
} from './firebase.js';
import { timeAgo } from './utils.js';

let currentChatId = null, currentRecipientUid = null;

onAuthStateChanged(auth, async user => {
  if(!user) return location='index.html';
  loadContacts();
});

async function loadContacts(){
  const snaps = await getDocs(query(collection(db,'users'), orderBy('createdAt','desc'), ));
  const out = document.getElementById('contacts'); out.innerHTML='';
  snaps.forEach(s=>{ const u=s.data();
    const div = document.createElement('div'); div.className='small';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${u.name}</div><button class="start">Chat</button></div>`;
    div.querySelector('.start').addEventListener('click', ()=> startChatWith(u));
    out.appendChild(div);
  });
}

async function startChatWith(userObj){
  // create a chat id deterministic by uids sorted
  const me = auth.currentUser;
  const uids = [me.uid, userObj.uid].sort().join('_');
  currentChatId = uids;
  currentRecipientUid = userObj.uid;
  openChat(uids);
}

async function openChat(chatId){
  const cw = document.getElementById('chatWindow');
  cw.innerHTML = '';
  const q = query(collection(db,'chats',chatId,'messages'), orderBy('createdAt','asc'));
  onSnapshot(q, snap=>{
    cw.innerHTML = '';
    snap.forEach(m => {
      const mm = m.data();
      const div = document.createElement('div'); div.className='small';
      div.style.textAlign = (mm.from === auth.currentUser.uid)? 'right' : 'left';
      div.innerHTML = `<div><b>${mm.fromName||mm.from}</b><div>${mm.text}</div><div class="small">${timeAgo(mm.createdAt?.toDate?.()||new Date())}</div></div>`;
      cw.appendChild(div);
    });
    cw.scrollTop = cw.scrollHeight;
  });
}

document.getElementById('sendChat').addEventListener('click', async ()=>{
  const text = document.getElementById('chatText').value.trim();
  if(!text || !currentChatId) return alert('Choose contact or type message');
  await addDoc(collection(db,'chats',currentChatId,'messages'), { from: auth.currentUser.uid, fromName: auth.currentUser.displayName || auth.currentUser.email, text, createdAt: serverTimestamp() });
  document.getElementById('chatText').value = '';
});
</script>
</body>
</html>
